# ==============================================================================
# GitHub Workflow: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–∂–∏–≤–æ–≥–æ" –∞—Ä—Ö–∏–≤–∞ —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏
# ==============================================================================
# –≠—Ç–æ—Ç –≤–æ—Ä–∫—Ñ–ª–æ—É —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ –ø–∞–ø–∫–µ `prompts` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
# –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–¥–∏–Ω-–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π "–∂–∏–≤–æ–π" —Ä–µ–ª–∏–∑ —Å —Ç–µ–≥–æ–º `latest-prompts`.
#
# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —ç—Ç–æ–º—É —Ä–µ–ª–∏–∑—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∞–º–æ–π —Å–≤–µ–∂–µ–π
# –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤.
#
# --- –¢–†–ò–ì–ì–ï–†–´ –ó–ê–ü–£–°–ö–ê ---
# 1. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò: –ø—Ä–∏ –ø—É—à–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É, –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã —Ñ–∞–π–ª—ã
#    –≤–Ω—É—Ç—Ä–∏ –ø–∞–ø–∫–∏ `prompts/`.
# 2. –í–†–£–ß–ù–£–Æ: —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "Actions" –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub.
# ==============================================================================

name: Update Prompts Library

on:
  # 1. –ó–∞–ø—É—Å–∫–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ –ø–∞–ø–∫–µ prompts
  push:
    branches:
      - main # –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å –≤–∞—à—É –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É (main –∏–ª–∏ master)
    paths:
      - 'prompts/**'

  # 2. –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:

# --- –í–ê–ñ–ù–û: –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í ---
# –Ø–≤–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ "contents" —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
# –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Å—Å–µ—Ç–æ–≤.
# –ë–µ–∑ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ 403 Forbidden.
permissions:
  contents: write

jobs:
  update_prompts_archive:
    name: Package and Update Prompts Archive
    runs-on: ubuntu-latest

    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v3

      # –®–∞–≥ 2: –°–æ–∑–¥–∞–µ–º zip-–∞—Ä—Ö–∏–≤ —Å –ø–∞–ø–∫–æ–π prompts
      - name: Archive prompts directory
        run: zip -r prompts.zip ./prompts

      # –®–∞–≥ 3: –û–±–Ω–æ–≤–ª—è–µ–º –∞—Å—Å–µ—Ç –≤ "–∂–∏–≤–æ–º" —Ä–µ–ª–∏–∑–µ
      # Action `softprops/action-gh-release` —Å–∞–º –Ω–∞–π–¥–µ—Ç —Ä–µ–ª–∏–∑ –ø–æ —Ç–µ–≥—É,
      # —Å–æ–∑–¥–∞—Å—Ç –µ–≥–æ, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –∞—Å—Å–µ—Ç—ã —Å
      # —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º.
      - name: Update or Create Release with Prompts Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-prompts # –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ç–µ–≥, –∫–æ—Ç–æ—Ä—ã–π –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
          name: "Prompts Library (Latest)"
          body: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤. –≠—Ç–æ—Ç —Ä–µ–ª–∏–∑ –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∞–º—É—é —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é."
          draft: false
          prerelease: false
          files: prompts.zip # Action –Ω–∞–π–¥–µ—Ç –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —ç—Ç–æ—Ç —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==============================================================================
      # –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–• –° –û–ë–†–ê–ë–û–¢–ö–û–ô –û–®–ò–ë–û–ö
      # ==============================================================================
      # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ prompts/ –≤–æ –≤–Ω–µ—à–Ω—é—é –ë–î —á–µ—Ä–µ–∑ API
      # –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: find, cat, jq, curl, –¥–æ—Å—Ç—É–ø –∫ —Å–µ–∫—Ä–µ—Ç–∞–º SYNC_WEBHOOK_URL –∏ SYNC_API_KEY
      # ==============================================================================
      - name: Sync to Database with Error Handling
        run: |
          echo "üîÑ Starting sync at $(date)"
          
          # 1. –°–ë–û–† –ò –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–†–û–ú–ü–¢–û–í
          # --------------------------------------------------------------------------
          # –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ JSON-—Ñ–∞–π–ª—ã –∏–∑ prompts/ –≤ –≤–∞–ª–∏–¥–Ω—ã–π –º–∞—Å—Å–∏–≤
          # –ü—Ä–∏ –æ—à–∏–±–∫–µ: –ª–æ–≥–≥–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç workflow
          if ! PROMPTS_JSON=$(find prompts -name "*.json" -exec cat {} \; | jq -s '.' 2>/dev/null); then
              echo "‚ùå ERROR: Invalid JSON format in prompt files"
              exit 1
          fi
          
          # 2. –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ù–ê API
          # --------------------------------------------------------------------------
          # –í—ã–ø–æ–ª–Ω—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ API –∫–ª—é—á
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç HTTP —Å—Ç–∞—Ç—É—Å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "${{ secrets.SYNC_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.SYNC_API_KEY }}" \
            -d "{\"prompts\": $PROMPTS_JSON, \"source\": \"github-action\"}")
          
          # 3. –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê
          # --------------------------------------------------------------------------
          # –£—Å–ø–µ—Ö: 2xx —Å—Ç–∞—Ç—É—Å—ã (200, 201, etc.)
          # –û—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞: 4xx (–Ω–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
          # –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: 5xx (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ API)
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
              echo "‚úÖ Sync completed successfully (HTTP $HTTP_STATUS)"
          elif [ "$HTTP_STATUS" -ge 400 ] && [ "$HTTP_STATUS" -lt 500 ]; then
              echo "‚ùå CLIENT ERROR: Check API key or data format (HTTP $HTTP_STATUS)"
              exit 1
          elif [ "$HTTP_STATUS" -ge 500 ]; then
              echo "‚ùå SERVER ERROR: External API is down (HTTP $HTTP_STATUS)"
              exit 1
          else
              echo "‚ùå UNKNOWN ERROR: Unexpected HTTP status $HTTP_STATUS"
              exit 1
          fi
          
          echo "üü¢ Sync completed at $(date)"