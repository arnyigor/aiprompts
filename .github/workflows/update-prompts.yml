# ==============================================================================
# GitHub Workflow: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–∂–∏–≤–æ–≥–æ" –∞—Ä—Ö–∏–≤–∞ —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏
# ==============================================================================
# –≠—Ç–æ—Ç –≤–æ—Ä–∫—Ñ–ª–æ—É —Å–ª–µ–¥–∏—Ç –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ –ø–∞–ø–∫–µ `prompts` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
# –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–¥–∏–Ω-–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π "–∂–∏–≤–æ–π" —Ä–µ–ª–∏–∑ —Å —Ç–µ–≥–æ–º `latest-prompts`.
#
# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —ç—Ç–æ–º—É —Ä–µ–ª–∏–∑—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∞–º–æ–π —Å–≤–µ–∂–µ–π
# –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤.
#
# --- –¢–†–ò–ì–ì–ï–†–´ –ó–ê–ü–£–°–ö–ê ---
# 1. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò: –ø—Ä–∏ –ø—É—à–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É, –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã —Ñ–∞–π–ª—ã
#    –≤–Ω—É—Ç—Ä–∏ –ø–∞–ø–∫–∏ `prompts/`.
# 2. –í–†–£–ß–ù–£–Æ: —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "Actions" –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub.
# ==============================================================================

name: Update Prompts Library

on:
  # 1. –ó–∞–ø—É—Å–∫–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ –ø–∞–ø–∫–µ prompts
  push:
    branches:
      - main # –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å –≤–∞—à—É –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É (main –∏–ª–∏ master)
    paths:
      - 'prompts/**'

  # 2. –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:

# --- –í–ê–ñ–ù–û: –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í ---
# –Ø–≤–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ "contents" —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
# –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Å—Å–µ—Ç–æ–≤.
# –ë–µ–∑ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ 403 Forbidden.
permissions:
  contents: write

jobs:
  update_prompts_archive:
    name: Package and Update Prompts Archive
    runs-on: ubuntu-latest

    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v3

      # –®–∞–≥ 2: –°–æ–∑–¥–∞–µ–º zip-–∞—Ä—Ö–∏–≤ —Å –ø–∞–ø–∫–æ–π prompts
      - name: Archive prompts directory
        run: zip -r prompts.zip ./prompts

      # –®–∞–≥ 3: –û–±–Ω–æ–≤–ª—è–µ–º –∞—Å—Å–µ—Ç –≤ "–∂–∏–≤–æ–º" —Ä–µ–ª–∏–∑–µ
      # Action `softprops/action-gh-release` —Å–∞–º –Ω–∞–π–¥–µ—Ç —Ä–µ–ª–∏–∑ –ø–æ —Ç–µ–≥—É,
      # —Å–æ–∑–¥–∞—Å—Ç –µ–≥–æ, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –∞—Å—Å–µ—Ç—ã —Å
      # —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º.
      - name: Update or Create Release with Prompts Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-prompts # –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ç–µ–≥, –∫–æ—Ç–æ—Ä—ã–π –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
          name: "Prompts Library (Latest)"
          body: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤. –≠—Ç–æ—Ç —Ä–µ–ª–∏–∑ –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∞–º—É—é —Å–≤–µ–∂—É—é –≤–µ—Ä—Å–∏—é."
          draft: false
          prerelease: false
          files: prompts.zip # Action –Ω–∞–π–¥–µ—Ç –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —ç—Ç–æ—Ç —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–•
      - name: Sync to Database with Chunked Upload
        run: |
          echo "üîÑ Starting chunked sync at $(date)"

          # –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –≤ –æ–¥–Ω–æ–π –ø–æ—Ä—Ü–∏–∏)
          CHUNK_SIZE=50

          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö JSON —Ñ–∞–π–ª–æ–≤
          find prompts -name "*.json" > files_list.txt

          # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
          split -l $CHUNK_SIZE files_list.txt chunk_

          for chunk_file in chunk_*; do
              echo "üì¶ Processing chunk: $chunk_file"

              # –°–æ–∑–¥–∞–µ–º JSON –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞–Ω–∫–∞
              TEMP_FILE=$(mktemp)
              while IFS= read -r file; do
                  cat "$file"
              done < "$chunk_file" | jq -s '.' > "$TEMP_FILE"

              # –°–æ–∑–¥–∞–µ–º payload
              PAYLOAD_FILE=$(mktemp)
              echo "{\"prompts\": $(cat "$TEMP_FILE"), \"source\": \"github-action\", \"chunk\": \"$chunk_file\"}" > "$PAYLOAD_FILE"

              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞–Ω–∫
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                -X POST "${{ secrets.SYNC_WEBHOOK_URL }}" \
                -H "Content-Type: application/json" \
                -H "X-API-Key: ${{ secrets.SYNC_API_KEY }}" \
                -d @"$PAYLOAD_FILE")

              # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
              rm -f "$TEMP_FILE" "$PAYLOAD_FILE"

              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
              if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
                  echo "‚úÖ Chunk $chunk_file synced successfully (HTTP $HTTP_STATUS)"
              else
                  echo "‚ùå Chunk $chunk_file failed (HTTP $HTTP_STATUS)"
                  exit 1
              fi

              # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —á–∞–Ω–∫–∞–º–∏
              sleep 1
          done

          # –û—á–∏—Å—Ç–∫–∞
          rm -f files_list.txt chunk_*

          echo "üü¢ All chunks synced successfully at $(date)"
